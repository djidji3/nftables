flush ruleset

# DEFINE VARIABLES
define INTERNET_DEV=enp0s3

define LAN_DEV=enp0s8
define LAN_NET=10.10.10.0/24

define DMZ_DEV=enp0s9
define DMZ_NET=10.20.20.0/24

define OP_IP=192.168.100.101
define MAILSERVER_IP=10.20.20.2
define MAILSERVER_PORT={ submission, imap2 }

# FILTER-TABLE
table inet filter-table { 
    # INPUT-CHAIN
    chain input-chain { 
        type filter hook input priority filter; policy drop;
			iif "lo" counter packets 0 bytes 0 accept \
                comment "lo KOMMUNIKACIO ENGEDVE" 
			ct state invalid counter packets 0 bytes 0 drop \
                comment "INVALID CSOMAGOK ELDOBVA"
			ct state established,related counter packets 52 bytes 3744 accept \
                comment "MAR LETEZO KAPCSOLATOK ENGEDVE" 
            ip saddr { $OP_IP } counter packets 431 bytes 30305 accept \
                comment "SAJAT GEPEMBROL MINDEN ENGEDVE" 
#			tcp dport ssh ct state new meter ssh-input-limit size 65535 { tcp dport . ip saddr limit rate over 2/minute } counter packets 0 bytes 0 drop comment "UJ SSH KAPCSOLAT INDITASANAK LIMITALASA" 
#            icmp type echo-request meter ping-limit size 65535 { ip saddr limit rate over 5/minute } counter packets 0 bytes 0 drop comment "PING KERESEK LIMITALASA" 
            icmp type echo-request counter packets 0 bytes 0 accept \
                comment "PING SZAMOLVA ES ENGEDVE" 
            ip6 nexthdr ipv6-icmp icmpv6 type { nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert } accept \
                comment "icmpv6 ENGEDVE" 
            iif $LAN_DEV ip saddr $LAN_NET counter packets 0 bytes 0 accept q
                comment "INSIDE > ROUTER SZAMOLVA ES BEENGEDVE A ROUTERRE" 
            counter packets 0 bytes 0 drop comment "MINDEN EGYEB SZAMOLVA ES ELDOBVA" 
         }

    # FORWARD-CHAIN
    chain forward-chain {
        type filter hook forward priority filter; policy drop;
            ct state invalid counter packets 0 bytes 0 drop comment "INVALID CSOMAGOK SZAMOLVA ES ELDOBVA" 
            ct state established,related counter packets 1 bytes 139 accept comment "MAR LETEZO KAPCSOLATOK SZAMOLVA ES ENGEDVE" 
            oifname $INTERNET_DEV jump forward2internet-chain comment "INTERNET FELE IRANYULO FORGALOM SZUROSZABALYAIHOZ UGRAS" 
            oifname $LAN_DEV jump forward2lan-chain comment "LAN FELE IRANYULO FORGALOM SZUROSZABALYAIHOZ UGRAS" 
            oifname $DMZ_DEV jump forward2dmz-chain comment "DMZ FELE IRANYULO FORGALOM SZUROSZABALYAIHOZ UGRAS" 
            counter packets 3 bytes 184 drop comment "MINDEN EGYEB SZAMOLVA ES ELDOBVA" 
        }

    
    # FORWARD2LAN-CHAIN
    chain forward2lan-chain {
        drop comment "MINDEN BELSO HALOZAT FELE IRANYULOL CSOMAG ELDOBVA"
    }
    
    # FORWARD2DMZ-CHAIN
    chain forward2dmz-chain {
#			tcp dport ssh ct state new meter ssh-dmz-limit size 65535 { tcp dport . ip saddr limit rate over 2/minute } counter packets 0 bytes 0 drop comment "UJ SSH KAPCSOLAT INDITASANAK LIMITALASA" 
            iifname $LAN_DEV ip protocol tcp ip saddr $LAN_NET ip daddr $MAILSERVER_IP tcp dport $MAILSERVER_PORT  ct state new counter packets 0 bytes 0 accept \
                comment "INSIDE > DMZ  MAIL PROTOKOLLOK SZAMOLVA ES ENGEDVE" 
            iifname $LAN_DEV ip saddr 10.10.10.2 ip daddr $DMZ_NET tcp dport 22 ct state new counter packets 0 bytes 0 accept \
                comment "INSIDE > DMZ UJ SSH KAPCSOLATOK SZAMOLVA ES ENGEDVE" 
            iifname $INTERNET_DEV ip protocol tcp ip daddr $MAILSERVER_IP tcp dport { $MAILSERVER_PORT, smtp } counter packets 0 bytes 0 accept \
                comment "NET > DMZ MAIL PROTOKOLLOK ENGEDVE" 
            iifname $LAN_DEV ip daddr $MAILSERVER_IP tcp dport ssh counter packets 0 bytes 0 accept \
                comment "INSIDE > DMZ AZ SSH FORGALOM NATOLASAHOZ A MAIL SERVERRE ENGEDVE" 
        
    }
    
    # FORWARD2INTERNET-CHAIN
    chain forward2internet-chain {
            iif $DMZ_DEV ip saddr $DMZ_NET counter packets 0 bytes 0 accept comment "DMZ > NET SZAMOLVA ES ENGEDVE" 
            iif $LAN_DEV ip saddr $LAN_NET accept comment "INSIDE > NET ENGEDVE" 
        
    }

    # INPUT-CHAIN
    chain output-chain { 
        type filter hook output priority filter; policy accept;
        }
}

# NAT-TABLE
table ip nat-table {
    # POSTROUTING-CHAIN
    chain postrouting-chain { 
        type nat hook postrouting priority filter; policy accept;
            oifname $INTERNET_DEV masquerade comment "NET IRANYBA MENO CSOMAGOK NAT-olva LESZNEK AZ ELSODLEGES PUBLIKUS IPCIMRE" 
        }

    # PREROUTING-CHAIN
    chain prerouting-chain {
        type nat hook prerouting priority filter; policy accept;
            iifname $INTERNET_DEV tcp dport { 25, 143 } dnat to $MAILSERVER_IP comment "NET-rol ERKEZO LEVELEZO PROTOKOLLOK NATOLASA A MAIL SERVERRE"
            iifname $INTERNET_DEV tcp dport 2222 dnat to $MAILSERVER_IP:22 comment "NET-rol A 2222 PORTRA ERKEZO CSOMAGOK NATOLASA A MAIL SERVER 22 PORTJARA " 
        }
}
